<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Máy Tính</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, sans-serif; background: #fff; height: 100vh; overflow: hidden; user-select: none; }
    .calculator { height: 100vh; display: flex; flex-direction: column; max-width: 500px; margin: 0 auto; }
    .history-section { flex: 1; overflow-y: auto; padding: 10px 15px; max-height: calc(100vh - 450px); }
    .history-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; margin-bottom: 8px; position: sticky; top: 0; background: white; z-index: 10; border-bottom: 1px solid #e0e0e0; }
    .history-title { font-size: 13px; font-weight: 600; color: #666; }
    .clear-history-btn { background: #ff3b30; color: white; border: none; border-radius: 6px; padding: 4px 12px; font-size: 11px; font-weight: 600; cursor: pointer; }
    .clear-history-btn:active { background: #d32f2f; transform: scale(0.95); }
    .history-list { display: flex; flex-direction: column; gap: 4px; }
    .history-item { background: #f5f5f5; padding: 6px 10px; border-radius: 8px; cursor: pointer; border: 1px solid #e0e0e0; display: flex; align-items: center; gap: 8px; }
    .history-item:active { background: #e8e8e8; }
    .history-content { flex: 1; min-width: 0; }
    .history-expression { font-size: 11px; color: rgba(0,0,0,0.5); margin-bottom: 2px; }
    .history-result { font-size: 14px; color: #333; font-weight: 600; }
    .history-edit-btn { width: 40px; height: 32px; padding: 0; font-size: 18px; display: flex; align-items: center; justify-content: center; border-radius: 4px; flex-shrink: 0; order: -1; background: transparent; border: none; }
    .history-edit-btn:active { background: rgba(0,0,0,0.05); transform: scale(0.95); }
    .no-history { text-align: center; color: rgba(0,0,0,0.3); font-size: 11px; padding: 15px; }
    .display { background: #f8f8f8; border-radius: 12px 12px 0 0; padding: 15px; text-align: right; border: 1px solid #e0e0e0; border-bottom: none; min-height: 100px; display: flex; flex-direction: column; justify-content: flex-end; }
    .expression { font-size: 16px; color: #999; display: none; cursor: text; }
    .expression.has-result { display: block; font-size: 18px; color: #666; margin-bottom: 8px; }
    .result { font-size: 42px; font-weight: 300; color: #1a1a1a; cursor: text; white-space: pre-wrap; word-break: break-all; }
    .result.editing { background: rgba(255,152,0,0.1); padding: 8px; border-radius: 8px; border: 2px solid #ff9500; font-size: 32px; }
    .cursor-indicator { display: inline-block; width: 2px; height: 1.2em; background: #ff9500; animation: blink 0.8s infinite; vertical-align: middle; }
    @keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0.3; } }
    .error-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(255,59,48,0.95); color: white; padding: 15px 30px; border-radius: 12px; font-size: 16px; font-weight: 600; z-index: 1000; animation: fadeInOut 1.5s; }
    @keyframes fadeInOut { 0%, 100% { opacity: 0; } 15%, 85% { opacity: 1; } }
    .keyboard-section { padding: 0 15px 15px; background: white; }
    .buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    button { border: none; border-radius: 16px; font-size: 24px; font-weight: 500; cursor: pointer; height: 65px; background: #e8e8e8; color: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    button:active { transform: scale(0.92); }
    .operator { background: #ff9500; color: white; position: relative; }
    .operator:active { background: #ff8000; }
    .operator-badge { position: absolute; top: 5px; right: 5px; font-size: 13px; opacity: 0.7; }
    .equals { background: #34c759; color: white; }
    .delete { color: #ff6b6b; font-size: 20px; }
  </style>
</head>
<body>
  <div class="calculator">
    <div class="history-section" id="historySection">
      <div class="history-header">
        <div class="history-title">Lịch sử</div>
        <button class="clear-history-btn" id="clearHistoryBtn">Xóa lịch sử</button>
      </div>
      <div class="history-list" id="historyList">
        <div class="no-history">Chưa có lịch sử</div>
      </div>
    </div>
    <div class="display">
      <div class="expression" id="expression"></div>
      <div class="result" id="result">0</div>
    </div>
    <div class="keyboard-section">
      <div class="buttons">
        <button class="function" id="acBtn">AC</button>
        <button class="delete" id="delBtn">⌫</button>
        <button class="function" id="openParenBtn">(</button>
        <button class="function" id="closeParenBtn">)</button>
        <button class="number" id="btn7">7</button>
        <button class="number" id="btn8">8</button>
        <button class="number" id="btn9">9</button>
        <button class="operator" id="divideBtn">÷<span class="operator-badge">√</span></button>
        <button class="number" id="btn4">4</button>
        <button class="number" id="btn5">5</button>
        <button class="number" id="btn6">6</button>
        <button class="operator" id="multiplyBtn">×<span class="operator-badge">^</span></button>
        <button class="number" id="btn1">1</button>
        <button class="number" id="btn2">2</button>
        <button class="number" id="btn3">3</button>
        <button class="operator" id="minusBtn">-<span class="operator-badge">%</span></button>
        <button class="number" id="btn0">0</button>
        <button class="number" id="btn000">000</button>
        <button class="number" id="btnDot">.</button>
        <button class="operator" id="plusBtn">+</button>
        <button class="function" id="leftArrowBtn">◄</button>
        <button class="equals" id="equalsBtn" style="grid-column: span 2;">=</button>
        <button class="function" id="rightArrowBtn">►</button>
      </div>
    </div>
  </div>
  <script>
    let currentInput = '0', currentExpression = '', history = JSON.parse(localStorage.getItem('calcHistory')) || [];
    let justCalculated = false, cursorPosition = 0, isEditMode = false;
    const resultDisplay = document.getElementById('result');
    const expressionDisplay = document.getElementById('expression');
    const historyList = document.getElementById('historyList');
    const historySection = document.getElementById('historySection');

    function showError(msg) {
      const toast = document.createElement('div');
      toast.className = 'error-toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 1500);
    }

    let audioContext;
    function playClickSound() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioContext.createOscillator(), gain = audioContext.createGain();
      osc.connect(gain); gain.connect(audioContext.destination);
      osc.frequency.value = 800; gain.gain.setValueAtTime(0.1, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
      osc.start(); osc.stop(audioContext.currentTime + 0.05);
    }

    function formatNumber(num) {
      if (!num) return '0';
      const parts = num.toString().split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return parts.join('.');
    }

    function updateCursorVisual() {
      if (!isEditMode) {
        resultDisplay.classList.remove('editing');
        resultDisplay.textContent = justCalculated ? "= " + formatNumber(currentInput) : formatNumber(currentInput);
        return;
      }
      resultDisplay.classList.add('editing');
      resultDisplay.innerHTML = '';
      const before = currentInput.substring(0, cursorPosition);
      const after = currentInput.substring(cursorPosition);
      if (before) resultDisplay.appendChild(document.createTextNode(before));
      const cursor = document.createElement('span');
      cursor.className = 'cursor-indicator';
      cursor.textContent = '|';
      resultDisplay.appendChild(cursor);
      if (after) resultDisplay.appendChild(document.createTextNode(after));
    }

    function enableEditMode() {
      isEditMode = true;
      if (justCalculated && currentExpression) {
        currentInput = currentExpression;
        justCalculated = false;
        currentExpression = '';
      }
      cursorPosition = currentInput.length;
      updateDisplay();
      updateCursorVisual();
    }

    function moveCursorLeft() { if (cursorPosition > 0) { cursorPosition--; updateCursorVisual(); } }
    function moveCursorRight() { if (cursorPosition < currentInput.length) { cursorPosition++; updateCursorVisual(); } }

    function insertAtCursor(char) {
      currentInput = currentInput.slice(0, cursorPosition) + char + currentInput.slice(cursorPosition);
      cursorPosition += char.length;
      updateDisplay();
      updateCursorVisual();
    }

    function deleteAtCursor() {
      if (cursorPosition > 0) {
        currentInput = currentInput.slice(0, cursorPosition - 1) + currentInput.slice(cursorPosition);
        cursorPosition--;
        if (!currentInput) currentInput = '0';
        updateDisplay();
        updateCursorVisual();
      }
    }

    function updateDisplay() {
      if (isEditMode) {
        expressionDisplay.style.display = 'none';
        expressionDisplay.classList.remove('has-result');
        resultDisplay.textContent = currentInput;
      } else if (justCalculated) {
        expressionDisplay.style.display = 'block';
        expressionDisplay.textContent = formatExpression(currentExpression);
        expressionDisplay.classList.add('has-result');
        resultDisplay.textContent = "= " + formatNumber(currentInput);
      } else {
        expressionDisplay.style.display = 'none';
        expressionDisplay.classList.remove('has-result');
        resultDisplay.textContent = formatInputDisplay(currentInput);
      }
    }

    function formatInputDisplay(input) {
      return input.replace(/\d+/g, m => m.length > 3 ? formatNumber(m) : m);
    }

    function formatExpression(expr) {
      return expr.replace(/\d+/g, m => m.length > 3 ? formatNumber(m) : m);
    }

    resultDisplay.addEventListener('click', enableEditMode);
    expressionDisplay.addEventListener('click', enableEditMode);

    function updateHistoryDisplay() {
      if (!history.length) {
        historyList.innerHTML = '<div class="no-history">Chưa có lịch sử</div>';
        return;
      }
      historyList.innerHTML = history.map((item, i) => `
        <div class="history-item">
          <button class="history-edit-btn" onclick="editHistoryExpression(${i}); event.stopPropagation();">✏️</button>
          <div class="history-content" onclick="useHistoryResult(${i})">
            <div class="history-expression">${formatExpression(item.expression)}</div>
            <div class="history-result">= ${formatNumber(item.result)}</div>
          </div>
        </div>
      `).join('');
      setTimeout(() => historySection.scrollTop = historySection.scrollHeight, 100);
    }

    function addToHistory(expr, res) {
      history.push({ expression: expr, result: res });
      if (history.length > 50) history.shift();
      localStorage.setItem('calcHistory', JSON.stringify(history));
      updateHistoryDisplay();
    }

    function useHistoryResult(index) {
      const item = history[index];
      if (currentInput !== '0' && !justCalculated) {
        const last = currentInput.trim().slice(-1);
        if (['+','-','×','÷','^','(','√'].includes(last)) currentInput += item.result;
        else if (/[\d)]$/.test(currentInput)) currentInput += ' + ' + item.result;
        else currentInput += item.result;
      } else currentInput = item.result;
      currentExpression = '';
      justCalculated = false;
      isEditMode = false;
      updateDisplay();
      updateCursorVisual();
      playClickSound();
    }

    function editHistoryExpression(index) {
      currentInput = history[index].expression;
      currentExpression = '';
      justCalculated = false;
      enableEditMode();
      playClickSound();
    }

    function clearHistory() {
      if (!history.length) return;
      if (confirm('Bạn có chắc muốn xóa toàn bộ lịch sử?')) {
        history = [];
        localStorage.setItem('calcHistory', JSON.stringify(history));
        updateHistoryDisplay();
        playClickSound();
      }
    }

    function appendNumber(num) {
      playClickSound();
      if (isEditMode) {
        if (num === '.') {
          const before = currentInput.substring(0, cursorPosition);
          const match = before.match(/[\d.]+$/);
          if (match && match[0].includes('.')) return;
        }
        const before = currentInput.substring(0, cursorPosition);
        if (before && /\)$/.test(before)) { insertAtCursor(' × ' + num); return; }
        insertAtCursor(num);
        return;
      }
      if (justCalculated) {
        currentInput = num;
        currentExpression = '';
        justCalculated = false;
      } else {
        if (num === '.') {
          const match = currentInput.match(/[\d.]+$/);
          if (match && match[0].includes('.')) return;
        }
        if (currentInput && currentInput !== '0' && /\)$/.test(currentInput)) currentInput += ' × ' + num;
        else if (currentInput === '0' && num !== '.') currentInput = num;
        else currentInput += num;
      }
      updateDisplay();
    }

    function deleteLastChar() {
      playClickSound();
      if (currentInput === '0' || currentInput.length === 1) currentInput = '0';
      else currentInput = currentInput.slice(0, -1);
      updateDisplay();
    }

    function addOperator(op) {
      playClickSound();
      if (isEditMode) { insertAtCursor(' ' + op + ' '); return; }
      if (!currentInput.endsWith(' ')) currentInput += ' ' + op + ' ';
      justCalculated = false;
      currentExpression = '';
      updateDisplay();
    }

    function addParenthesis(type) {
      playClickSound();
      if (isEditMode) {
        if (type === '(') {
          const before = currentInput.substring(0, cursorPosition);
          if (before && before !== '0' && /[\d)]$/.test(before)) { insertAtCursor(' × ('); return; }
        } else {
          const after = currentInput.substring(cursorPosition);
          if (after && /^[\d(]/.test(after)) { insertAtCursor(') × '); return; }
        }
        insertAtCursor(type);
        return;
      }
      if (type === '(') {
        if (currentInput === '0') currentInput = '(';
        else if (/[\d)]$/.test(currentInput)) currentInput += ' × (';
        else currentInput += '(';
      } else currentInput += ')';
      updateDisplay();
    }

    function addSpecialOperator(op) {
      playClickSound();
      if (isEditMode) {
        if (op === '√') {
          const before = currentInput.substring(0, cursorPosition);
          if (before && before !== '0' && /[\d)]$/.test(before)) insertAtCursor(' × √');
          else insertAtCursor('√');
        } else insertAtCursor(op);
        return;
      }
      if (op === '√') {
        if (currentInput === '0') currentInput = '√';
        else if (/[\d)]$/.test(currentInput)) currentInput += ' × √';
        else currentInput += '√';
      } else currentInput += op;
      updateDisplay();
    }

    function calculate() {
      playClickSound();
      try {
        let expr = currentInput.replace(/,/g, '');
        currentExpression = currentInput;
        expr = expr.replace(/(\d+)%/g, '($1/100)');
        expr = expr.replace(/√\(([^)]+)\)/g, 'Math.sqrt($1)');
        expr = expr.replace(/√(\d+\.?\d*)/g, 'Math.sqrt($1)');
        expr = expr.replace(/×/g, '*').replace(/÷/g, '/').replace(/\^/g, '**');
        const result = eval(expr);
        if (!isFinite(result)) {
          showError('Lỗi: Phép tính không hợp lệ');
          currentExpression = '';
          enableEditMode();
          return;
        }
        let resultStr = result.toString();
        if (resultStr.length > 15) resultStr = parseFloat(resultStr).toFixed(8).replace(/\.?0+$/, '');
        addToHistory(currentExpression, resultStr);
        currentInput = resultStr;
        justCalculated = true;
        isEditMode = false;
        updateDisplay();
        updateCursorVisual();
      } catch {
        showError('Lỗi: Cú pháp không đúng');
        currentExpression = '';
        enableEditMode();
      }
    }

    function clearAll() {
      playClickSound();
      currentInput = '0';
      currentExpression = '';
      justCalculated = false;
      isEditMode = false;
      updateDisplay();
      updateCursorVisual();
    }

    let delTimer, delInterval, delLongPress = false;
    function startDelLongPress() {
      delLongPress = false;
      delTimer = setTimeout(() => {
        delLongPress = true;
        delInterval = setInterval(() => { isEditMode ? deleteAtCursor() : deleteLastChar(); }, 100);
      }, 500);
    }
    function stopDelLongPress() {
      clearTimeout(delTimer);
      clearInterval(delInterval);
      if (!delLongPress) isEditMode ? deleteAtCursor() : deleteLastChar();
      delLongPress = false;
    }
    document.getElementById('delBtn').addEventListener('touchstart', startDelLongPress);
    document.getElementById('delBtn').addEventListener('touchend', stopDelLongPress);
    document.getElementById('delBtn').addEventListener('mousedown', startDelLongPress);
    document.getElementById('delBtn').addEventListener('mouseup', stopDelLongPress);

    let leftTimer, leftInterval;
    function startLeftLongPress() {
      leftTimer = setTimeout(() => { leftInterval = setInterval(moveCursorLeft, 100); }, 500);
    }
    function stopLeftLongPress() { clearTimeout(leftTimer); clearInterval(leftInterval); }
    document.getElementById('leftArrowBtn').addEventListener('touchstart', startLeftLongPress);
    document.getElementById('leftArrowBtn').addEventListener('touchend', stopLeftLongPress);

    let rightTimer, rightInterval;
    function startRightLongPress() {
      rightTimer = setTimeout(() => { rightInterval = setInterval(moveCursorRight, 100); }, 500);
    }
    function stopRightLongPress() { clearTimeout(rightTimer); clearInterval(rightInterval); }
    document.getElementById('rightArrowBtn').addEventListener('touchstart', startRightLongPress);
    document.getElementById('rightArrowBtn').addEventListener('touchend', stopRightLongPress);

    let divTimer, divLongPress = false;
    document.getElementById('divideBtn').addEventListener('touchstart', () => {
      divLongPress = false;
      divTimer = setTimeout(() => { divLongPress = true; addSpecialOperator('√'); }, 500);
    });
    document.getElementById('divideBtn').addEventListener('touchend', () => clearTimeout(divTimer));
    document.getElementById('divideBtn').onclick = () => { if (!divLongPress) addOperator('÷'); };

    let multTimer, multLongPress = false;
    document.getElementById('multiplyBtn').addEventListener('touchstart', () => {
      multLongPress = false;
      multTimer = setTimeout(() => { multLongPress = true; addSpecialOperator('^'); }, 500);
    });
    document.getElementById('multiplyBtn').addEventListener('touchend', () => clearTimeout(multTimer));
    document.getElementById('multiplyBtn').onclick = () => { if (!multLongPress) addOperator('×'); };

    let minusTimer, minusLongPress = false;
    document.getElementById('minusBtn').addEventListener('touchstart', () => {
      minusLongPress = false;
      minusTimer = setTimeout(() => { minusLongPress = true; addSpecialOperator('%'); }, 500);
    });
    document.getElementById('minusBtn').addEventListener('touchend', () => clearTimeout(minusTimer));
    document.getElementById('minusBtn').onclick = () => { if (!minusLongPress) addOperator('-'); };

    document.getElementById('btn7').onclick = () => appendNumber('7');
    document.getElementById('btn8').onclick = () => appendNumber('8');
    document.getElementById('btn9').onclick = () => appendNumber('9');
    document.getElementById('btn4').onclick = () => appendNumber('4');
    document.getElementById('btn5').onclick = () => appendNumber('5');
    document.getElementById('btn6').onclick = () => appendNumber('6');
    document.getElementById('btn1').onclick = () => appendNumber('1');
    document.getElementById('btn2').onclick = () => appendNumber('2');
    document.getElementById('btn3').onclick = () => appendNumber('3');
    document.getElementById('btn0').onclick = () => appendNumber('0');
    document.getElementById('btn000').onclick = () => appendNumber('000');
    document.getElementById('btnDot').onclick = () => appendNumber('.');
    document.getElementById('openParenBtn').onclick = () => addParenthesis('(');
    document.getElementById('closeParenBtn').onclick = () => addParenthesis(')');
    document.getElementById('plusBtn').onclick = () => addOperator('+');
    document.getElementById('equalsBtn').onclick = calculate;
    document.getElementById('acBtn').onclick = clearAll;
    document.getElementById('leftArrowBtn').onclick = () => { playClickSound(); if (!isEditMode) enableEditMode(); moveCursorLeft(); };
    document.getElementById('rightArrowBtn').onclick = () => { playClickSound(); if (!isEditMode) enableEditMode(); moveCursorRight(); };
    document.getElementById('clearHistoryBtn').onclick = clearHistory;

    updateDisplay();
    updateHistoryDisplay();
  </script>
</body>
</html>
